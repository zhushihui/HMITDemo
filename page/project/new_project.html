<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/bootstrap-table.css">
<link rel="stylesheet" href="../../css/bootstrap-select.min.css">
<style type="text/css">@import "../../css/global.css";</style>
<style type="text/css">@import "../../css/bootstrapValidator.css";</style>
<script src="../../js/jquery/jquery-1.12.3.js"></script>
<script src="../../js/jquery/jquery-form.js"></script>
<script src="../../js/mergeRowsCell.js"></script>
<script src="../../js/jquery/jquery.validate.js"></script>
<script src="../../js/bootstrap-js/bootstrap.min.js"></script>
<script src="../../js/bootstrap-js/bootstrap-table.js"></script>
<script src="../../js/bootstrap-js/bootstrap-select.min.js"></script>
<script src="../../js/bootstrap-js/bootstrapValidator.js"></script>
<script src="../../js/export/bootstrap-table-export.js"></script>
<script src="../../js/export/tableExport.js"></script>
<script src="../../js/My97DatePicker/WdatePicker.js"></script>
<body>
<div class="project">
    <div class="row">
        <div class="col-md-2">
            <div class="projectmenu">
                <div class="title">
                    新增 项目
                </div>
                <div class="info">
                    相关信息
                </div>
                <div class="menulist">
                    <ul>
                        <li>项目进度</li>
                        <li>采购信息</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-10">
            <div class="projectform">
                <div class="projectforminput">
                    <div class="row">
                        <div class="col-md-12">
                            <form id="projectForm" method="post" class="form-horizontal">
                                <table class="table" border=1 cellspacing="0" cellpadding=0 width=100%>
                                    <thead>
                                    <td colspan=4 class="editrelhead">
                                        <b>基本信息</b>
                                    </td>
                                    </thead>
                                    <tr>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            <i style="color: red">*</i>项目名称
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">

                                            <input type="text" fieldonly='1' id="proName" name="proName" tabindex="" value=""
                                                   tabindex="" class="detailedViewTextBox"
                                                   onfocus="this.className='detailedViewTextBoxOn'"
                                                   onBlur="this.className='detailedViewTextBox'"
                                                   style="width:70%;float:left;"/>
                                        </td>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            客户名称
                                        </td>
                                        <td width="30%" id="customerListId" align="left" class="DetailedTd2Info">
                                            <div  style="width: 70%;height: 30px; float: left;">
                                                <select id="cusId" name="cusId" class="selectpicker show-tick form-control" data-live-search="true" title="请选择">
                                                    <optgroup id="customerList" label="客户" >

                                                    </optgroup>
                                                </select>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            项目类型
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <div  style="width: 70%;height: 30px; float: left;">
                                                <select id="pTName" name="pTName" class="selectpicker show-tick form-control" data-live-search="true" title="请选择">
                                                    <optgroup id="pTNameList" label="项目类型" >

                                                    </optgroup>
                                                </select>
                                            </div>
                                        </td>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            项目金额
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <input type="text" fieldonly='1' tabindex="" name="proMoney" id="proMoney"
                                                   class=detailedViewTextBox
                                                   onFocus="this.className='detailedViewTextBoxOn'"
                                                   onBlur="this.className='detailedViewTextBox'"
                                                   style="width:70%;float:left;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            合同编号
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <input type="text" fieldonly='1' tabindex="" name="conId" id="conId"
                                                   class=detailedViewTextBox
                                                   onFocus="this.className='detailedViewTextBoxOn'"
                                                   onBlur="this.className='detailedViewTextBox'"
                                                   style="width:70%;float:left;">
                                        </td>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            执行时间
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <input class="Wdate" id="beginDate" name="beginDate" type="text" onfocus="WdatePicker()"
                                                   readonly/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            签订日期
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <input class="Wdate" id="signDate" name="signDate" type="text" onfocus="WdatePicker()"
                                                   readonly/>
                                        </td>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            预收日期
                                        </td>
                                        <td width="30%" align="left" class="DetailedTd2Info">
                                            <input class="Wdate" id="recevablesDate" name="recevablesDate" type="text" onfocus="WdatePicker()"
                                                   readonly/>
                                        </td>
                                    <tr>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            <i style="color: red">*</i>项目经理
                                        </td>
                                        <td id="projectManager" width="30%" align="left" class="DetailedTd2Info">
                                            <div  style="width: 70%;height: 30px; float: left;">
                                                <select id="proBrokerage" name="proBrokerage"  class="selectpicker show-tick form-control" data-live-search="true" title="请选择">
                                                    <optgroup id="projectManagerList" label="负责人" >

                                                    </optgroup>
                                                </select>
                                            </div>
                                        </td>
                                        <td width="20%" class="DetailedTd1Label" align="right">
                                            备注
                                        </td>
                                    <td width="80%" align="left" class="DetailedTd2Info">
                                    <textarea class="detailedViewTextBox" tabindex="" fieldonly='0'
                                              onFocus="this.className='detailedViewTextBoxOn'" name="notes"
                                              id="notes" onBlur="this.className='detailedViewTextBox'" cols="90"
                                              style="height:50px"></textarea>
                                    </td>
                                    </tr>
                                </table>
                            </form>
                        </div>
                        <div class="col-md-12">
                            <table class="table" border=1 cellspacing="0" cellpadding=0 width=100%>
                                <thead>
                                <td colspan=4 class="editrelhead">
                                    <b>导入设备信息</b>
                                </td>
                                </thead>
                            </table>
                            <div class="projectBtn">
                                <div class="row">
                                    <div class="col-md-12">
                                        <form  id="readReportForm" action="" method="post" >
                                            <table id='readRoprtTable'>
                                                <tr>
                                                    <td><input id="fileUpload" name="fileUpload" type="file"></td>
                                                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                        <button id="readReportForma" type="submit" class="btn btn-success save">
                                                            导入
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <button id="cancel" class="btn btn-danger cancel">
                                                            清空
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <table class="table" border=1 cellspacing="0" cellpadding=0 width=100%>
                                <thead>
                                <td colspan=10 class="editrelhead">
                                    <b>采购单</b>
                                </td>
                                </thead>
                            </table>
                        </div>
                        <div>
                            <table id="table">
                                <thead>
                                <tr>
                                    <th data-field="equName">设备名称</th>
                                    <th data-field="equDescription">品牌型号</th>
                                    <th data-field="supName">供应商</th>
                                    <th data-field="equNumber">数量</th>
                                    <th data-field="sellPrice">销售单价</th>
                                    <th data-field="sellTotalPrice">销售总价</th>
                                    <th data-field="remarks">配置描述</th>
                                    <th data-field="ifWholeSale">批发</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                        <div class="projectBtn">
                            <button class="btn btn-success save" onclick="saveProject();">保存</button>
                            <button class="btn btn-danger cancel">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    var $table = $('#table');

        $(function () {
            var data = [];
            $table.bootstrapTable({data: data});
        });

    var LocString = String(window.document.location.href);
    function getQueryStr(str) {
        var rs = new RegExp("(^|)" + str + "=([^&]*)(&|$)", "gi").exec(LocString), tmp;
        if (tmp = rs) {
            return tmp[2];
        }
// parameter cannot be found
        return "";
    }
    var formCusId = getQueryStr("cusId");
    var formCusName = decodeURIComponent(getQueryStr("cusName"));
    if(formCusId!=""){
        document.getElementById("cusId").removeAttribute("title");
        $('#customerList').append("<option value=" + formCusId + ">" + formCusName + "</option>");
    }else{
        //客户下拉框
        $.ajax({
            url: "../../../HMITCRM/getCustomerList",
            dataType: "json",
            success: function (data) {
                JSON.stringify(data);
                for (var i = 0; i<data.length; i++){
                    $('#customerList').append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
                    $('.selectpicker').selectpicker('val', '');
                    $('.selectpicker').selectpicker('refresh');
                }
            }
        });

    }
    //经理人下拉框
    $.ajax({
        url: "../../../HMITCRM//getProBrokeragList",
        dataType: "json",
        success: function (data) {
            JSON.stringify(data);
            for (var i = 0; i<data.length; i++){
                $('#projectManagerList').append("<option value=" + data[i].empId + ">" + data[i].empName + "</option>");
                $('.selectpicker').selectpicker('val', '');
                $('.selectpicker').selectpicker('refresh');
            }
        }
    });
    //项目类型下拉框
    $.ajax({
        url: "../../../HMITCRM//getProjectTypeList",
        dataType: "json",
        success: function (data) {
            JSON.stringify(data);
            for (var i = 0; i<data.length; i++){
                $('#pTNameList').append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
                $('.selectpicker').selectpicker('val', '');
                $('.selectpicker').selectpicker('refresh');
            }
        }
    });

    $(document).ready(function(){
        $("#readReportForm").resetForm().validate({
            rules: {
                "fileUpload": {
                    required: true,
                    accept: "xls"
                }
            },
            messages: {
                "fileUpload": {
                    required: "请选择上传文件",
                    accept: "文件格式不支持，请上传 xls 格式的文件"
                }
            },
            submitHandler: function() {
                $("#readReportForm").ajaxSubmit({
                    url:"../../../HMITCRM//readProjectSuppReport",
                    type:"post",
                    enctype:"multipart/form-data",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    dataType:"json",
                    success: function(data){
                        var obj = eval(data);
                        $(function () {
                            $('#table').bootstrapTable('load',{data: obj.rows});
                        });
                    },
                    error: function() {
                        alert('error');
                    }
                });
                return false;
            }
        });

    });

    var sy = $.extend({}, sy);
    sy.serializeObject = function (form) { /*将form表单内的元素序列化为对象，扩展Jquery的一个方法*/
        var o = {};
        $.each(form.serializeArray(), function (index) {
            if (o[this['name']]) {
                o[this['name']] = o[this['name']] + "," + this['value'];
            } else {
                o[this['name']] = this['value'];
            }
        });
        return o;
    };
    var url;
    var type;
    function saveProject(){
        var allTableData = $("#table").bootstrapTable('getData');
        var suppOrder = encodeURI(JSON.stringify(allTableData),"UTF-8");
        var data1 = sy.serializeObject($('#projectForm'));
        data1.empName =$('#projectManagerList option:selected').text();
        data1.pTName = $('#pTNameList option:selected').text();
        var data = encodeURI(JSON.stringify(data1),"UTF-8");
        url = '../../../HMITCRM/createNewProject';
        $.ajax({
            url : url,
            data : "data=" + data+"="+suppOrder,
            datatype :'json',
            type : 'post',
            success : function(result){
                var o =  eval("("+result+")");
                if (o.result=="success"){
                    alert(o.msg);
                    location.href='project_detail_index.html?data='+data;
                }
                else {
                    alert(o.msg);
                }
            },
            error : function(){}
        })
    }

</script>
</body>
</html>