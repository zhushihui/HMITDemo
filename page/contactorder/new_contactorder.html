<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/bootstrap-table.css">
<link rel="stylesheet" href="../../css/bootstrap-select.min.css">
<style type="text/css">@import "../../css/global.css";</style>
<script src="../../js/jquery/jquery-1.12.3.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src="../../js/bootstrap-table.js"></script>
<script src="../../js/bootstrap-js/bootstrap-select.min.js"></script>
<script src="../../js/export/bootstrap-table-export.js"></script>
<script src="../../js/export/tableExport.js"></script>
<script src="../../js/My97DatePicker/WdatePicker.js"></script>

<body>
<div class="contactorder">
    <div class="row">
        <div class="col-md-2">
            <div class="contactordermenu">
                <div class="title">
                    新增 合同订单
                </div>
                <div class="info">
                    相关信息
                </div>
            </div>
        </div>
        <div class="col-md-10">
            <div class="contactorderform">
                <form id="contractForm" method="post" class="form-horizontal">
                <div class="contactorderforminput">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table" border=1 cellspacing="0" cellpadding=0 width=100%>
                                <thead>
                                <td colspan=4 class="editrelhead">
                                    <b>基本信息</b>
                                </td>
                                </thead>
                                <tr>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        <i style="color: red">*</i>订单名称
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <div  style="width: 70%;height: 30px; float: left;">
                                            <select id="proId" name="proId" class="selectpicker show-tick form-control" data-live-search="true" title="请选择">
                                                <optgroup id="proIdList" label="订单" >

                                                </optgroup>
                                            </select>
                                        </div>
                                    </td>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        订单状态
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input type="text" style="float:left;width:260px;" fieldonly='1' tabindex=""
                                               name="status" id="status"
                                               class=detailedViewTextBox
                                               onFocus="this.className='detailedViewTextBoxOn'"
                                               onBlur="this.className='detailedViewTextBox'">
                                    </td>
                                </tr>
                                <tr>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        客户名称
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <div  style="width: 70%;height: 30px; float: left;">
                                            <select id="cusId" name="cusId" class="selectpicker show-tick form-control" data-live-search="true" title="请选择">
                                                <optgroup id="customerList" label="客户" >

                                                </optgroup>
                                            </select>
                                        </div>
                                    </td>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        编号
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input type="text" style="width:260px;" fieldonly='1' tabindex=""
                                               name="id" id="id"
                                               class=detailedViewTextBox
                                               onFocus="this.className='detailedViewTextBoxOn'"
                                               onBlur="this.className='detailedViewTextBox'"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        联系人姓名
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input type="text" style="width:260px;" fieldonly='1' tabindex=""
                                               name="contactPerson" id="contactPerson"
                                               class=detailedViewTextBox
                                               onFocus="this.className='detailedViewTextBoxOn'"
                                               onBlur="this.className='detailedViewTextBox'"/>
                                    </td>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        销售负责人
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input type="text" style="width:260px;" fieldonly='1' tabindex=""
                                               name="saleResp" id="saleResp"
                                               class=detailedViewTextBox
                                               onFocus="this.className='detailedViewTextBoxOn'"
                                               onBlur="this.className='detailedViewTextBox'"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        代理人
                                    </td>
                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input type="text" style="width:260px;" fieldonly='1' tabindex=""
                                               name="agent" id="agent"
                                               class=detailedViewTextBox
                                               onFocus="this.className='detailedViewTextBoxOn'"
                                               onBlur="this.className='detailedViewTextBox'"/>
                                    </td>
                                    <td width="20%" class="DetailedTd1Label" align="right">
                                        交付日期
                                    </td>

                                    <td width="30%" align="left" class="DetailedTd2Info">
                                        <input class="Wdate" id="deliverDate" name="deliverDate" type="text" onfocus="WdatePicker()"
                                               readonly/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="contactorderforminput">
                    <table class="table" border=1 cellspacing="0" cellpadding=0 width=100%>
                        <thead>
                        <td colspan=4 class="editrelhead">
                            <b>备注信息</b>
                        </td>
                        </thead>
                        <tr>
                            <td width="20%" class="DetailedTd1Label" align="right">
                                备注
                            </td>
                            <td width="80%" align="left" class="DetailedTd2Info">
                                <textarea class="detailedViewTextBox" tabindex="" fieldonly='0'
                                          onFocus="this.className='detailedViewTextBoxOn'" name="notes"
                                          id="notes" onBlur="this.className='detailedViewTextBox'" cols="90"
                                          style="height:50px"></textarea>
                            </td>
                        </tr>
                    </table>
                    <div class="contactorderBtn">
                        <button class="btn btn-success save" onclick="saveContractOrder();" type="button">保存</button>
                        <button class="btn btn-danger cancel">取消</button>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    var LocString = String(window.document.location.href);
    function getQueryStr(str) {
        var rs = new RegExp("(^|)" + str + "=([^&]*)(&|$)", "gi").exec(LocString), tmp;
        if (tmp = rs) {
            return tmp[2];
        }
        // parameter cannot be found
        return "";
    }
    var formCusId = getQueryStr("cusId");
    var formCusName = decodeURIComponent(getQueryStr("cusName"));
    if(formCusId!=""){
        document.getElementById("cusId").removeAttribute("title");
        $('#customerList').append("<option value=" + formCusId + ">" + formCusName + "</option>");
    }else{
        //客户下拉框
        $.ajax({
            url: "../../../HMITCRM/getCustomerList",
            dataType: "json",
            success: function (data) {
                JSON.stringify(data);
                for (var i = 0; i<data.length; i++){
                    $('#customerList').append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
                    $('.selectpicker').selectpicker('val', '');
                    $('.selectpicker').selectpicker('refresh');
                }
            }
        });
    }

    //项目名称下拉框
    $.ajax({
        url: "../../../HMITCRM/getProjectNameList",
        dataType: "json",
        success: function (data) {
            JSON.stringify(data);
            for (var i = 0; i<data.length; i++){
                $('#proIdList').append("<option value=" + data[i].id + ">" + data[i].name + "</option>");
                $('.selectpicker').selectpicker('val', '');
                $('.selectpicker').selectpicker('refresh');
            }
        }
    });

    function saveContractOrder(){
        var sy = $.extend({}, sy);
        sy.serializeObject = function (form) { /*将form表单内的元素序列化为对象，扩展Jquery的一个方法*/
            var o = {};
            $.each(form.serializeArray(), function (index) {
                if (o[this['name']]) {
                    o[this['name']] = o[this['name']] + "," + this['value'];
                } else {
                    o[this['name']] = this['value'];
                }
            });
            return o;
        };
        var url;
        var data1 = sy.serializeObject($('#contractForm'));
        data1.cusName =$('#customerList option:selected').text();
        data1.proName = $('#proIdList option:selected').text();
        var data = encodeURI(JSON.stringify(data1),"UTF-8");
        url = '../../../HMITCRM/addContract';
        $.ajax({
            url : url,
            data : 'data=' + data,
            datatype :'json',
            type : 'post',
            success : function(result){
                var o =  eval("("+result+")");
                if (o.result=="success"){
                    alert(o.msg);
                    location.href='contactorder_detail_index.html?data='+data;
                }
                else {
                    alert(o.msg);
                }
            },
            error : function(){}
        })
    }

</script>
</body>
</html>